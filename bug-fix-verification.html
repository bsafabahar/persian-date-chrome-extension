<!DOCTYPE html>
<html>
<head>
    <title>Bug Fix Verification - 1404/02/31 Error</title>
    <script src="lib/persian-date.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-result { margin: 5px 0; padding: 5px; }
        .pass { background-color: #d4edda; color: #155724; }
        .fail { background-color: #f8d7da; color: #721c24; }
        .info { background-color: #d1ecf1; color: #0c5460; }
        .critical { background-color: #fff3cd; color: #856404; font-weight: bold; }
        h1 { color: #333; }
        h2 { color: #666; margin-top: 20px; }
        .summary { border: 2px solid #333; padding: 15px; margin: 20px 0; }
    </style>
</head>
<body>
    <h1>üîß Bug Fix Verification - Persian Date "1404/02/31" Error</h1>
    <div id="results"></div>
    
    <script>
        const results = document.getElementById('results');
        
        let totalTests = 0;
        let passedTests = 0;
        let failedTests = 0;
        let bugStillExists = false;
        
        function log(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `test-result ${type}`;
            div.innerHTML = message;
            results.appendChild(div);
        }
        
        function testDate(inputDate, description) {
            totalTests++;
            
            try {
                const date = new Date(inputDate);
                if (isNaN(date.getTime())) {
                    log(`‚ö†Ô∏è ${description}: Invalid input date "${inputDate}"`, 'info');
                    return;
                }
                
                const [jYear, jMonth, jDay] = PersianDate.toJalali(date);
                const result = `${jYear}/${jMonth.toString().padStart(2, '0')}/${jDay.toString().padStart(2, '0')}`;
                
                // Validate the result
                let isValid = true;
                let issues = [];
                
                if (jYear < 1 || jMonth < 1 || jMonth > 12 || jDay < 1) {
                    isValid = false;
                    issues.push('Basic range violation');
                }
                
                if (jMonth <= 6 && jDay > 31) {
                    isValid = false;
                    issues.push(`Month ${jMonth} cannot have ${jDay} days (max 31)`);
                } else if (jMonth > 6 && jMonth <= 11 && jDay > 30) {
                    isValid = false;
                    issues.push(`Month ${jMonth} cannot have ${jDay} days (max 30)`);
                } else if (jMonth === 12) {
                    const maxDays = PersianDate.isLeapYear(jYear) ? 30 : 29;
                    if (jDay > maxDays) {
                        isValid = false;
                        issues.push(`Month 12 in year ${jYear} cannot have ${jDay} days (max ${maxDays})`);
                    }
                }
                
                // Check for the specific bug we're fixing
                if (result === '1404/02/31') {
                    isValid = false;
                    issues.push('üö® THE ORIGINAL BUG: 1404/02/31');
                    bugStillExists = true;
                }
                
                const status = isValid ? '‚úÖ' : '‚ùå';
                const type = isValid ? 'pass' : 'fail';
                
                if (isValid) {
                    passedTests++;
                } else {
                    failedTests++;
                }
                
                const issueText = issues.length > 0 ? ` - Issues: ${issues.join(', ')}` : '';
                log(`${status} ${description}: "${inputDate}" ‚Üí ${result}${issueText}`, type);
                
                // Special highlighting for the bug we're looking for
                if (result === '1404/02/31') {
                    log(`üö® CRITICAL: Found the bug! Date "${inputDate}" still produces 1404/02/31`, 'critical');
                }
                
            } catch (error) {
                failedTests++;
                log(`‚ùå ${description}: ERROR - ${error.message}`, 'fail');
            }
        }
        
        // Test critical dates around where the bug was happening
        log('<h2>üéØ Critical Test Cases (Where Bug Was Occurring)</h2>');
        
        const criticalDates = [
            '2025-05-20', '2025-05-21', '2025-05-22', '2025-05-23', 
            '2025-05-24', '2025-05-25', '2025-05-26', '2025-05-27',
            '2025-05-28', '2025-05-29', '2025-05-30', '2025-05-31'
        ];
        
        criticalDates.forEach((date, index) => {
            testDate(date, `Critical Test ${index + 1}`);
        });
        
        // Test user's original problematic dates
        log('<h2>üìã User Reported Problem Dates</h2>');
        testDate('2025-04-21', 'Similar to "21/Apr/25" format');
        
        // Test month boundaries that might cause issues
        log('<h2>üèîÔ∏è Persian Month Boundaries</h2>');
        testDate('2025-04-20', 'End of Persian Month 1 (Farvardin)');
        testDate('2025-04-21', 'Start of Persian Month 2 (Ordibehesht)');
        testDate('2025-05-21', 'End of Persian Month 2 (Ordibehesht)');
        testDate('2025-05-22', 'Start of Persian Month 3 (Khordad)');
        testDate('2025-06-21', 'End of Persian Month 3 (Khordad)');
        testDate('2025-06-22', 'Start of Persian Month 4 (Tir)');
        
        // Additional edge cases
        log('<h2>üß™ Additional Edge Cases</h2>');
        testDate('2025-03-20', 'Persian New Year 1404');
        testDate('2025-03-21', 'Day after Persian New Year');
        testDate('2026-03-20', 'End of Persian year 1404');
        
        // Summary
        setTimeout(() => {
            const summaryDiv = document.createElement('div');
            summaryDiv.className = 'summary';
            
            let summaryHtml = '<h2>üìä Test Summary</h2>';
            summaryHtml += `<p><strong>Total Tests:</strong> ${totalTests}</p>`;
            summaryHtml += `<p><strong>Passed:</strong> <span style="color: green;">${passedTests}</span></p>`;
            summaryHtml += `<p><strong>Failed:</strong> <span style="color: red;">${failedTests}</span></p>`;
            
            if (bugStillExists) {
                summaryHtml += '<p style="color: red; font-weight: bold; font-size: 18px;">üö® THE BUG STILL EXISTS! Extension still produces "1404/02/31"</p>';
                summaryHtml += '<p>The conversion algorithm needs further fixing.</p>';
            } else if (failedTests === 0) {
                summaryHtml += '<p style="color: green; font-weight: bold; font-size: 18px;">üéâ ALL TESTS PASSED! The "1404/02/31" bug appears to be fixed!</p>';
                summaryHtml += '<p>No invalid Persian dates were generated.</p>';
            } else {
                summaryHtml += '<p style="color: orange; font-weight: bold; font-size: 18px;">‚ö†Ô∏è Some tests failed, but the "1404/02/31" bug was not found.</p>';
                summaryHtml += '<p>There may be other issues with the conversion algorithm.</p>';
            }
            
            summaryDiv.innerHTML = summaryHtml;
            results.appendChild(summaryDiv);
            
            // Update page title based on results
            if (bugStillExists) {
                document.title = '‚ùå Bug Still Exists - 1404/02/31';
            } else if (failedTests === 0) {
                document.title = '‚úÖ Bug Fixed - All Tests Pass';
            } else {
                document.title = '‚ö†Ô∏è Partial Fix - Some Issues Remain';
            }
            
        }, 100);
    </script>
</body>
</html>
